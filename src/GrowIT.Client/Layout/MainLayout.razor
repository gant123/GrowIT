@inherits LayoutComponentBase
@inject NavigationManager NavManager
@using GrowIT.Client.Auth
@inject AuthenticationStateProvider AuthStateProvider
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject IJSRuntime JSRuntime

<div class="growit-app">
    <aside class="growit-sidebar">
        <div class="sidebar-brand">
           
                   @if (isDarkMode)
                {
                    <img src="images/logo-dark.png" alt="GrowIT" class="brand-logo" />
                }
                else
                {
                     <img src="images/logo-light.png" alt="GrowIT" class="brand-logo" />
                }
        </div>
        <nav class="sidebar-nav">
            <NavMenu />
        </nav>
    </aside>

    <main class="growit-main">
        <header class="growit-topbar">
            <div class="topbar-left">
                <div class="fiscal-selector">
                    <span class="oi oi-calendar"></span>
                    <span class="fiscal-text">FY 2026 · Q1</span>
                    <span class="oi oi-chevron-bottom"></span>
                </div>
                <div class="search-box">
                    <span class="oi oi-magnifying-glass"></span>
                    <input type="text" placeholder="Search clients, funds, or services... (Cmd K)" />
                </div>
            </div>
            <div class="topbar-right">
                <button class="btn btn-link text-decoration-none me-4" @onclick="ToggleTheme">
                @if (isDarkMode)
                {
                    <span class="oi oi-sun text-warning fs-5" title="Switch to Light Mode"></span>
                }
                else
                {
                    <span class="oi oi-moon text-secondary fs-5" title="Switch to Dark Mode"></span>
                }
            </button>
                <AuthorizeView>
                    <Authorized>
                        <button class="btn-plant-seed">
                            <span class="oi oi-plus"></span>
                            <span>Plant Seed</span>
                        </button>
                        <div class="user-area">
                            <div class="user-avatar">@GetInitials(context.User.Identity?.Name)</div>
                            <button class="btn-logout" @onclick="Logout" title="Sign Out">
                                <span class="oi oi-account-logout"></span>
                            </button>
                        </div>
                    </Authorized>
                    <NotAuthorized>
                        <a href="login" class="btn-login-link">Log In</a>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        </header>

        <div class="growit-content">
            @Body
        </div>
    </main>
</div>

@code {
    private bool isDarkMode = false;
    protected override async Task OnInitializedAsync()
    {
        // Load preference from JS when app starts
        var currentTheme = await JSRuntime.InvokeAsync<string>("themeManager.getTheme");
        isDarkMode = currentTheme == "dark";
    }
    private async Task ToggleTheme()
    {
        isDarkMode = !isDarkMode;
        var newTheme = isDarkMode ? "dark" : "light";
        await JSRuntime.InvokeVoidAsync("themeManager.setTheme", newTheme);
    }
    private string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split('@')[0].Split('.');
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name.Substring(0, Math.Min(2, name.Length)).ToUpper();
    }

    private async Task Logout()
    {
        await LocalStorage.RemoveItemAsync("authToken");
        await ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsLoggedOut();
        NavManager.NavigateTo("/login");
    }
}
