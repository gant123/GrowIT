@inherits LayoutComponentBase
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject IAuthService AuthService

<div class="growit-app" data-theme="@_currentTheme">
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" @onclick="CloseMobileSidebar"></div>
    
    <!-- Sidebar Navigation -->
    <aside class="growit-sidebar @(_sidebarCollapsed ? "collapsed" : "")">
        <div class="sidebar-header">
            <a href="/" class="sidebar-brand">
                <img src="images/logo-@(_currentTheme).png" alt="GrowIT" class="brand-logo" />
                <span class="brand-text">grow.IT</span>
            </a>
            <button class="sidebar-collapse-btn" @onclick="ToggleSidebar" title="Toggle sidebar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 19l-7-7 7-7M18 19l-7-7 7-7" class="collapse-icon"/>
                </svg>
            </button>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-label">Main</div>
                <NavLink href="/" class="nav-item" Match="NavLinkMatch.All">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                    </span>
                    <span class="nav-text">Dashboard</span>
                </NavLink>
                
                <NavLink href="/clients" class="nav-item">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </span>
                    <span class="nav-text">Case Files</span>
                </NavLink>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-label">Impact</div>
                <NavLink href="/funds" class="nav-item">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                        </svg>
                    </span>
                    <span class="nav-text">Funds</span>
                </NavLink>

                <NavLink href="/programs" class="nav-item">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        </svg>
                    </span>
                    <span class="nav-text">Programs</span>
                </NavLink>
                
                <NavLink href="/imprints" class="nav-item">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                    </span>
                    <span class="nav-text">Imprints</span>
                </NavLink>

                <NavLink href="/growth-plans" class="nav-item">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                            <circle cx="12" cy="12" r="4"/>
                        </svg>
                    </span>
                    <span class="nav-text">Growth Plans</span>
                </NavLink>
            </div>
            
            <AuthorizeView Roles="Admin,Manager">
                <div class="nav-section">
                    <div class="nav-section-label">Intelligence</div>
                    <NavLink href="/reports" class="nav-item">
                        <span class="nav-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                                <path d="M22 12A10 10 0 0 0 12 2v10z"/>
                            </svg>
                        </span>
                        <span class="nav-text">Reports</span>
                    </NavLink>
                    
                    <NavLink href="/insights" class="nav-item">
                        <span class="nav-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                            </svg>
                        </span>
                        <span class="nav-text">Insights</span>
                    </NavLink>
                </div>
            </AuthorizeView>
            
            <div class="nav-section">
                <div class="nav-section-label">System</div>
                <NavLink href="/organization" class="nav-item">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                        </svg>
                    </span>
                    <span class="nav-text">Organization</span>
                </NavLink>

                <NavLink href="/settings" class="nav-item">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                    </span>
                    <span class="nav-text">Settings</span>
                </NavLink>
            </div>
        </nav>
        
        <!-- User Profile Area -->
        <div class="sidebar-footer">
            <div class="sidebar-user">
                <div class="sidebar-user-avatar">
                    <span>@_userInitials</span>
                </div>
                <div class="sidebar-user-info">
                    <span class="sidebar-user-name">@_userName</span>
                    <span class="sidebar-user-role">@_userRole</span>
                </div>
                <button class="user-menu-btn" @onclick="ToggleUserMenu">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>
                    </svg>
                </button>
            </div>
        </div>
    </aside>
    
    <!-- Main Content Area -->
    <main class="growit-main @(_sidebarCollapsed ? "sidebar-collapsed" : "")">
        <!-- Top Bar -->
        <header class="growit-topbar">
            <div class="topbar-left">
                <button class="mobile-menu-btn" @onclick="OpenMobileSidebar" title="Open menu">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
                
                <nav class="breadcrumbs">
                    @foreach (var crumb in _breadcrumbs)
                    {
                        <div class="breadcrumb-item @(crumb.IsLast ? "active" : "")">
                            @if (crumb.IsLast)
                            {
                                <span>@crumb.Label</span>
                            }
                            else
                            {
                                <a href="@crumb.Href">@crumb.Label</a>
                                <span class="breadcrumb-separator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                        <polyline points="9 18 15 12 9 6"/>
                                    </svg>
                                </span>
                            }
                        </div>
                    }
                </nav>
            </div>
            
            <div class="topbar-center">
                <div class="topbar-search">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                        <input type="text" placeholder="Search anything (⌘K)" 
                               @bind="_searchQuery" @bind:event="oninput" 
                               @onkeyup="HandleSearchKeyUp" />
                        <div class="search-shortcut">⌘K</div>
                    </div>
                </div>
            </div>
            
            <div class="topbar-right">
                <div class="topbar-actions">
                    <div class="fiscal-year-container">
                        <select @bind="_selectedFiscalYear" @bind:after="OnFiscalYearChanged" class="fiscal-select-input">
                            <option value="FY24-25">FY 2024-25</option>
                            <option value="FY23-24">FY 2023-24</option>
                            <option value="FY22-23">FY 2022-23</option>
                        </select>
                        <svg class="select-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>

                    <div class="action-divider"></div>

                    <button class="topbar-btn theme-toggle" @onclick="ToggleTheme" title="Toggle theme">
                        @if (_currentTheme == "dark")
                        {
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                            </svg>
                        }
                        else
                        {
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                        }
                    </button>
                    
                    <div class="dropdown-container">
                        <button class="topbar-btn notifications-btn @(_notificationsOpen ? "active" : "")" @onclick="ToggleNotifications" title="Notifications">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                            </svg>
                            @if (_notificationCount > 0)
                            {
                                <span class="notification-badge">@(_notificationCount > 9 ? "9+" : _notificationCount.ToString())</span>
                            }
                        </button>
                        
                        @if (_notificationsOpen)
                        {
                            <div class="topbar-dropdown notifications-dropdown">
                                <div class="dropdown-header">
                                    <h3>Notifications</h3>
                                    <button class="btn-link" @onclick="MarkNotificationsAsRead" @onclick:stopPropagation="true">Mark all as read</button>
                                </div>
                                <div class="dropdown-body">
                                    <div class="notification-item @(_notificationCount > 0 ? "unread" : "")">
                                        <div class="notification-icon success">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                        </div>
                                        <div class="notification-content">
                                            <p><strong>New Impact Documented</strong> for John Smith</p>
                                            <span class="notification-time">2 minutes ago</span>
                                        </div>
                                    </div>
                                    @if (_notificationCount > 1)
                                    {
                                        <div class="notification-item unread">
                                            <div class="notification-icon info">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                                            </div>
                                            <div class="notification-content">
                                                <p>Grant report for <strong>FY24 Q3</strong> is ready</p>
                                                <span class="notification-time">1 hour ago</span>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div class="dropdown-footer">
                                    <a href="/notifications" @onclick="ToggleNotifications">View all notifications</a>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="dropdown-container">
                        <button class="user-profile-btn" @onclick="ToggleUserMenu">
                            <div class="user-avatar">@_userInitials</div>
                            <svg class="select-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </button>
                        
                        @if (_userMenuOpen)
                        {
                            <div class="topbar-dropdown user-dropdown">
                                <div class="user-dropdown-header">
                                    <div class="user-avatar lg">@_userInitials</div>
                                    <div class="user-details">
                                        <span class="user-name">@_userName</span>
                                        <span class="user-email">@_userEmail</span>
                                    </div>
                                </div>
                                <div class="dropdown-body">
                                    <NavLink href="/profile" class="dropdown-item" @onclick="() => _userMenuOpen = false">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                        Profile Settings
                                    </NavLink>
                                    <NavLink href="/settings" class="dropdown-item" @onclick="() => _userMenuOpen = false">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                                        System Preferences
                                    </NavLink>
                                    <div class="dropdown-divider"></div>
                                    <button class="dropdown-item logout" @onclick="HandleLogout" @onclick:stopPropagation="true">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                        Sign Out
                                    </button>
                                </div>
                            </div>
                        }
                    </div>

                    <button class="btn btn-primary btn-plant" @onclick="OpenPlantSeedModal">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        <span>Plant Seed</span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Page Content -->
        <div class="growit-content">
            @Body
        </div>
    </main>

    <GrowIT.Client.Shared.PlantSeedModal @bind-Show="_plantSeedModalOpen" />
</div>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;

    private string _userName = "User";
    private string _userEmail = "";
    private string _userRole = "Guest";
    private string _userInitials = "U";

    private string _currentTheme = "light";
    private bool _sidebarCollapsed = false;
    private string _searchQuery = "";
    private string _selectedFiscalYear = "FY24-25";
    private int _notificationCount = 3;
    private bool _userMenuOpen = false;
    private bool _notificationsOpen = false;
    private bool _plantSeedModalOpen = false;
    private List<Breadcrumb> _breadcrumbs = new();

    private class Breadcrumb
    {
        public string Label { get; set; } = "";
        public string Href { get; set; } = "";
        public bool IsLast { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        Navigation.LocationChanged += OnLocationChanged;
        UpdateBreadcrumbs();
    }

    protected override async Task OnParametersSetAsync()
    {
        var authState = await AuthState;
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            _userName = user.Identity.Name ?? "User";
            _userEmail = user.FindFirst(c => c.Type == "email" || c.Type == System.Security.Claims.ClaimTypes.Email)?.Value ?? "";
            _userRole = user.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.Role)?.Value ?? "User";
            
            if (!string.IsNullOrEmpty(_userName))
            {
                var parts = _userName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                if (parts.Length > 1)
                {
                    _userInitials = $"{parts[0][0]}{parts[^1][0]}".ToUpper();
                }
                else if (parts.Length == 1)
                {
                    _userInitials = parts[0][0].ToString().ToUpper();
                }
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _currentTheme = await JS.InvokeAsync<string>("blazorInterop.getTheme");
            _selectedFiscalYear = await JS.InvokeAsync<string>("fiscalYearManager.get");
            StateHasChanged();
        }
    }

    private async Task OnFiscalYearChanged()
    {
        await JS.InvokeVoidAsync("fiscalYearManager.set", _selectedFiscalYear);
        await JS.InvokeVoidAsync("blazorInterop.showToast", $"Fiscal Year changed to {_selectedFiscalYear}", "success");
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateBreadcrumbs();
        StateHasChanged();
    }

    private void UpdateBreadcrumbs()
    {
        var uri = new Uri(Navigation.Uri);
        var segments = uri.AbsolutePath.Split('/', StringSplitOptions.RemoveEmptyEntries);
        
        _breadcrumbs.Clear();
        _breadcrumbs.Add(new Breadcrumb { Label = "Home", Href = "/", IsLast = segments.Length == 0 });
        
        var path = "";
        for (int i = 0; i < segments.Length; i++)
        {
            path += "/" + segments[i];
            var label = FormatBreadcrumbLabel(segments[i]);
            _breadcrumbs.Add(new Breadcrumb 
            { 
                Label = label, 
                Href = path, 
                IsLast = i == segments.Length - 1 
            });
        }
    }

    private string FormatBreadcrumbLabel(string segment)
    {
        // Convert URL segment to readable label
        var label = segment.Replace("-", " ");
        return System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(label);
    }

    private async Task ToggleTheme()
    {
        _currentTheme = await JS.InvokeAsync<string>("blazorInterop.toggleTheme");
        StateHasChanged();
    }

    private async Task HandleLogout()
    {
        _userMenuOpen = false;
        await AuthService.Logout();
        Navigation.NavigateTo("/welcome");
    }

    private void ToggleSidebar()
    {
        _sidebarCollapsed = !_sidebarCollapsed;
    }

    private async Task OpenMobileSidebar()
    {
        _sidebarCollapsed = false; // Ensure it's not collapsed when opening mobile
        await JS.InvokeVoidAsync("sidebarManager.openMobile");
    }

    private async Task CloseMobileSidebar()
    {
        await JS.InvokeVoidAsync("sidebarManager.closeMobile");
    }

    private void ToggleUserMenu()
    {
        _userMenuOpen = !_userMenuOpen;
        if (_userMenuOpen) _notificationsOpen = false;
        StateHasChanged();
    }

    private void ToggleNotifications()
    {
        _notificationsOpen = !_notificationsOpen;
        if (_notificationsOpen) _userMenuOpen = false;
        StateHasChanged();
    }

    private void MarkNotificationsAsRead()
    {
        _notificationCount = 0;
        JS.InvokeVoidAsync("blazorInterop.showToast", "All notifications marked as read", "success");
        StateHasChanged();
    }

    private void OpenPlantSeedModal()
    {
        _plantSeedModalOpen = true;
    }

    private void HandleSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_searchQuery))
        {
            // For now, let's just toast what we searched
            JS.InvokeVoidAsync("blazorInterop.showToast", $"Searching for: {_searchQuery}", "info");
        }
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
