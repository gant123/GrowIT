@page "/clients"
@using GrowIT.Shared.DTOs
@using Syncfusion.Blazor.Grids
@inject HttpClient Http
@inject NavigationManager NavManager
@attribute [Authorize]

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Client Directory</h1>
            <p class="text-muted small mb-0">Search and manage growth plans.</p>
        </div>
        <a href="clients/create" class="btn btn-success shadow-sm">
            <span class="oi oi-plus me-2"></span> Add New Client
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body">
            @if (clients == null)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Loading directory...</p>
                </div>
            }
            else
            {
                <SfGrid DataSource="@clients" AllowPaging="true" AllowSorting="true" AllowFiltering="true" Toolbar="@(new List<string>() { "Search", "ExcelExport", "PdfExport" })">
                    <GridPageSettings PageSize="15"></GridPageSettings>
                    <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Menu"></GridFilterSettings>
                    
                    <GridEvents OnRecordClick="RecordClickHandler" TValue="ClientDto"></GridEvents>

                    <GridColumns>
                        <GridColumn Field=@nameof(ClientDto.Name) HeaderText="Name" Width="220">
                            <Template>
                                @{
                                    var client = (context as ClientDto);
                                    if (client != null)
                                    {
                                        <div class="d-flex align-items-center cursor-pointer">
                                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-3 text-uppercase" 
                                                 style="width: 40px; height: 40px; font-weight: bold; color: var(--grow-green); border: 1px solid #e3e6f0;">
                                                @(client.Name.Length > 0 ? client.Name.Substring(0, 1) : "?")
                                            </div>
                                            <div>
                                                <div class="fw-bold text-dark">@client.Name</div>
                                                <div class="small text-muted">@client.Email</div>
                                            </div>
                                        </div>
                                    }
                                }
                            </Template>
                        </GridColumn>

                        <GridColumn Field=@nameof(ClientDto.Phone) HeaderText="Phone" Width="140"></GridColumn>

                        <GridColumn Field=@nameof(ClientDto.StabilityScore) HeaderText="Stability" Width="150" TextAlign="TextAlign.Center">
                            <Template>
                                @{
                                    var clientData = (context as ClientDto);
                                    if (clientData != null)
                                    {
                                        var score = clientData.StabilityScore;
                                        <div class="d-flex align-items-center">
                                            <span class="small me-2 fw-bold text-muted" style="width: 30px;">@score/10</span>
                                            <div class="progress flex-grow-1" style="height: 6px;">
                                                <div class="progress-bar @GetScoreColor(score)" role="progressbar" 
                                                     style="width: @(score * 10)%" 
                                                     aria-valuenow="@score" aria-valuemin="0" aria-valuemax="10">
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                            </Template>
                        </GridColumn>

                        <GridColumn Field=@nameof(ClientDto.LifePhase) HeaderText="Phase" Width="130" TextAlign="TextAlign.Center">
                            <Template>
                                @{
                                    var phaseClient = (context as ClientDto);
                                    if (phaseClient != null)
                                    {
                                        <span class="badge rounded-pill @GetPhaseBadge(phaseClient.LifePhase) px-3">
                                            @phaseClient.LifePhase
                                        </span>
                                    }
                                }
                            </Template>
                        </GridColumn>

                        <GridColumn HeaderText="" Width="100" TextAlign="TextAlign.Center">
                            <Template>
                                @{
                                    var actionClient = (context as ClientDto);
                                    if (actionClient != null)
                                    {
                                        <button class="btn btn-sm btn-outline-primary rounded-pill" 
                                                @onclick="() => NavigateToDetail(actionClient.Id)">
                                            View
                                        </button>
                                    }
                                }
                            </Template>
                        </GridColumn>
                    </GridColumns>
                </SfGrid>
            }
        </div>
    </div>
</div>

@code {
    private List<ClientDto>? clients;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            clients = await Http.GetFromJsonAsync<List<ClientDto>>("api/clients");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading clients: {ex.Message}");
        }
    }

    private void NavigateToDetail(Guid id)
    {
        NavManager.NavigateTo($"clients/{id}");
    }

    private void RecordClickHandler(RecordClickEventArgs<ClientDto> args)
    {
        NavigateToDetail(args.RowData.Id);
    }

    // --- Helper Methods for UI Logic ---

    private string GetScoreColor(int score) 
    {
        if (score < 4) return "bg-danger";
        if (score < 7) return "bg-warning";
        return "bg-success";
    }

    private string GetPhaseBadge(string phase) 
    {
        if (string.IsNullOrEmpty(phase)) return "bg-secondary";
        
        return phase switch
        {
            "Crisis" => "bg-danger",
            "Stable" => "bg-warning text-dark",
            "Thriving" => "bg-success",
            _ => "bg-secondary"
        };
    }
}