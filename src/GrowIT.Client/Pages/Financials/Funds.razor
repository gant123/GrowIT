@page "/financials"
@using GrowIT.Shared.DTOs
@attribute [Authorize]
@inject HttpClient Http
@inject NavigationManager NavManager

<div class="financials-page">
    <div class="page-header">
        <div class="header-left">
            <h1 class="page-title">Financials</h1>
            <p class="page-subtitle">Manage funds, programs, and track investments</p>
        </div>
        <div class="header-actions">
            <button class="btn-secondary" @onclick="OpenProgramModal">
                <span>üìã</span> New Program
            </button>
            <button class="btn-primary" @onclick="OpenFundModal">
                <span>üí∞</span> New Fund
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-row">
        <div class="summary-card">
            <div class="summary-icon funds">üí∞</div>
            <div class="summary-content">
                <span class="summary-label">Total Funds</span>
                <span class="summary-value">$@TotalCapital.ToString("N0")</span>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon available">‚úÖ</div>
            <div class="summary-content">
                <span class="summary-label">Available</span>
                <span class="summary-value success">$@TotalAvailable.ToString("N0")</span>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon deployed">üìä</div>
            <div class="summary-content">
                <span class="summary-label">Deployed</span>
                <span class="summary-value">@DeploymentRate.ToString("0")%</span>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon programs">üìã</div>
            <div class="summary-content">
                <span class="summary-label">Programs</span>
                <span class="summary-value">@programCount</span>
            </div>
        </div>
    </div>

    <!-- Funds Table -->
    <div class="data-section">
        <div class="section-header">
            <h2>Fund Allocation</h2>
        </div>
        <div class="table-container">
            @if (funds == null)
            {
                <div class="loading-state">
                    <div class="spinner"></div>
                    <span>Loading funds...</span>
                </div>
            }
            else if (!funds.Any())
            {
                <div class="empty-state">
                    <span class="empty-icon">üí∞</span>
                    <p>No funds created yet</p>
                    <button class="btn-primary" @onclick="OpenFundModal">Create First Fund</button>
                </div>
            }
            else
            {
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fund Name</th>
                            <th class="align-right">Total Budget</th>
                            <th class="align-right">Available</th>
                            <th class="align-center">Status</th>
                            <th class="align-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var fund in funds)
                        {
                            var percentUsed = fund.TotalAmount > 0
                                ? ((fund.TotalAmount - fund.AvailableAmount) / fund.TotalAmount) * 100
                                : 0;
                            var statusClass = percentUsed > 90 ? "critical" : percentUsed > 75 ? "warning" : "healthy";
                            var statusText = percentUsed > 90 ? "Critical" : percentUsed > 75 ? "Low" : "Healthy";

                            <tr>
                                <td>
                                    <div class="fund-name">
                                        <span class="fund-icon">üíº</span>
                                        <span>@fund.Name</span>
                                    </div>
                                </td>
                                <td class="align-right">@fund.TotalAmount.ToString("C0")</td>
                                <td class="align-right">@fund.AvailableAmount.ToString("C0")</td>
                                <td class="align-center">
                                    <span class="status-badge @statusClass">@statusText</span>
                                </td>
                                <td class="align-center">
                                    <button class="icon-btn" title="Edit">‚úèÔ∏è</button>
                                    <button class="icon-btn danger" title="Delete">üóëÔ∏è</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>
</div>

@* Fund Creation Modal *@
@if (showFundModal)
{
    <div class="modal-overlay" @onclick="CloseFundModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Create New Fund</h3>
                <button class="modal-close" @onclick="CloseFundModal">√ó</button>
            </div>
            <EditForm Model="@newFund" OnValidSubmit="HandleCreateFund">
                <DataAnnotationsValidator />
                <div class="modal-body">
                    <div class="form-group">
                        <label>Fund Name</label>
                        <InputText @bind-Value="newFund.Name" class="form-input" placeholder="e.g. Emergency Relief Fund" />
                        <ValidationMessage For="@(() => newFund.Name)" />
                    </div>
                    <div class="form-group">
                        <label>Initial Budget ($)</label>
                        <InputNumber @bind-Value="newFund.TotalAmount" class="form-input" />
                        <ValidationMessage For="@(() => newFund.TotalAmount)" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" @onclick="CloseFundModal">Cancel</button>
                    <button type="submit" class="btn-primary">Create Fund</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@* Program Creation Modal *@
@if (showProgramModal)
{
    <div class="modal-overlay" @onclick="CloseProgramModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Create New Program</h3>
                <button class="modal-close" @onclick="CloseProgramModal">√ó</button>
            </div>
            <EditForm Model="@newProgram" OnValidSubmit="HandleCreateProgram">
                <DataAnnotationsValidator />
                <div class="modal-body">
                    <div class="form-group">
                        <label>Program Name</label>
                        <InputText @bind-Value="newProgram.Name" class="form-input" placeholder="e.g. Utility Assistance" />
                        <ValidationMessage For="@(() => newProgram.Name)" />
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <InputText @bind-Value="newProgram.Description" class="form-input" placeholder="Brief description of the program" />
                    </div>
                    <div class="form-group">
                        <label>Default Unit Cost ($)</label>
                        <InputNumber @bind-Value="newProgram.DefaultUnitCost" class="form-input" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" @onclick="CloseProgramModal">Cancel</button>
                    <button type="submit" class="btn-primary">Create Program</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private List<FundDto>? funds;
    private CreateFundRequest newFund = new();
    private CreateProgramRequest newProgram = new();
    private bool showFundModal = false;
    private bool showProgramModal = false;
    private int programCount = 0;

    private decimal TotalCapital => funds?.Sum(f => f.TotalAmount) ?? 0;
    private decimal TotalAvailable => funds?.Sum(f => f.AvailableAmount) ?? 0;
    private decimal DeploymentRate => TotalCapital > 0 ? ((TotalCapital - TotalAvailable) / TotalCapital) * 100 : 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            funds = await Http.GetFromJsonAsync<List<FundDto>>("api/financials/funds");
            var programs = await Http.GetFromJsonAsync<List<object>>("api/financials/programs");
            programCount = programs?.Count ?? 0;
        }
        catch
        {
            funds = new List<FundDto>();
        }
    }

    private void OpenFundModal() => showFundModal = true;
    private void CloseFundModal() => showFundModal = false;
    private void OpenProgramModal() => showProgramModal = true;
    private void CloseProgramModal() => showProgramModal = false;

    private async Task HandleCreateFund()
    {
        var response = await Http.PostAsJsonAsync("api/financials/funds", newFund);
        if (response.IsSuccessStatusCode)
        {
            CloseFundModal();
            newFund = new();
            await LoadData();
        }
    }

    private async Task HandleCreateProgram()
    {
        var response = await Http.PostAsJsonAsync("api/financials/programs", newProgram);
        if (response.IsSuccessStatusCode)
        {
            CloseProgramModal();
            newProgram = new();
            await LoadData();
        }
    }
}
