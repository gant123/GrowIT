@page "/forgot-password"
@layout PublicLayout
@using GrowIT.Shared.DTOs
@using GrowIT.Client.Services
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Reset Password - grow.IT</PageTitle>

<div class="auth-page">
    <div class="auth-container auth-container-centered">
        <div class="auth-card">
            <!-- Logo -->
            <div class="auth-logo">
                <a href="/welcome">
                    <img src="images/logo-@(_currentTheme).png" alt="GrowIT" class="brand-logo" />
                </a>
            </div>

            @if (!_emailSent)
            {
                <!-- Request Form -->
                <div class="auth-header">
                    <h1>Reset your password</h1>
                    <p>Enter your email and we'll send you a link to reset your password.</p>
                </div>

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="auth-alert error">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        <span>@_errorMessage</span>
                    </div>
                }

                <form class="auth-form" @onsubmit="HandleSubmit" @onsubmit:preventDefault>
                    <div class="form-group">
                        <label for="email">Email address</label>
                        <div class="input-wrapper">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="input-icon">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            <input type="email" 
                                   id="email" 
                                   @bind="_email" 
                                   @bind:event="oninput"
                                   placeholder="you@nonprofit.org"
                                   autocomplete="email"
                                   required />
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block btn-lg" disabled="@_isLoading">
                        @if (_isLoading)
                        {
                            <span class="btn-spinner"></span>
                            <span>Sending...</span>
                        }
                        else
                        {
                            <span>Send Reset Link</span>
                        }
                    </button>
                </form>
            }
            else
            {
                <!-- Success State -->
                <div class="auth-success">
                    <div class="success-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                    </div>
                    <h2>Check your email</h2>
                    <p>We've sent a password reset link to:</p>
                    <p class="email-sent-to">@_email</p>
                    <p class="hint">Didn't receive the email? Check your spam folder or <button class="btn-link" @onclick="ResetForm">try again</button>.</p>
                </div>
            }

            <!-- Footer -->
            <div class="auth-footer">
                <a href="/login" class="back-link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="19" y1="12" x2="5" y2="12"/>
                        <polyline points="12 19 5 12 12 5"/>
                    </svg>
                    Back to sign in
                </a>
            </div>
        </div>
    </div>
</div>

@code {
    private string _currentTheme = "light";
    private string _email = "";
    private bool _isLoading = false;
    private bool _emailSent = false;
    private string? _errorMessage;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _currentTheme = await JS.InvokeAsync<string>("blazorInterop.getTheme");
            StateHasChanged();
        }
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(_email))
        {
            _errorMessage = "Please enter your email address.";
            return;
        }

        _errorMessage = null;
        _isLoading = true;

        try
        {
            var success = await AuthService.ForgotPassword(new ForgotPasswordRequest { Email = _email });
            
            if (success)
            {
                _emailSent = true;
            }
            else
            {
                _errorMessage = "Unable to process your request. Please try again later.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "An error occurred. Please try again later.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ResetForm()
    {
        _emailSent = false;
        _email = "";
    }
}
