@page "/growth-plans"
@using GrowIT.Shared.DTOs
@using GrowIT.Shared.Enums
@inject NavigationManager Navigation

<PageTitle>Growth Plans - grow.IT</PageTitle>

<div class="page-growth-plans">
    <PageHeader Title="Growth Plans" Subtitle="Track progress and goals for people in your community.">
        <Actions>
            <button class="btn btn-primary" @onclick="OpenNewPlan">
                <span class="oi oi-plus me-2"></span>New Growth Plan
            </button>
        </Actions>
    </PageHeader>

    <div class="row mb-4">
        <div class="col-md-6">
            <input type="text" class="form-control" placeholder="Search..." @bind="SearchQuery" @bind:event="oninput" />
        </div>
    </div>

    <div class="plans-grid">
        @if (!FilteredPlans.Any())
        {
            <div class="alert alert-info">No growth plans found.</div>
        }
        else 
        {
            @foreach (var plan in FilteredPlans)
            {
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h5 class="card-title">@plan.Title</h5>
                            <span class="badge bg-primary">@plan.Season</span>
                        </div>
                        <h6 class="card-subtitle mb-2 text-muted">@plan.PersonName</h6>
                        
                        <div class="progress mt-3" style="height: 10px;">
                            <div class="progress-bar bg-success" style="width: @($"{plan.ProgressPercentage}%")"></div>
                        </div>
                        <small class="text-muted">@plan.ProgressPercentage.ToString("F0")% Complete</small>
                        
                        <div class="mt-3 text-end">
                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => ViewPlan(plan.Id)">View</button>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    // Now uses Shared DTOs
    private List<GrowthPlanListDto> _allPlans = new();
    private string SearchQuery { get; set; } = "";

    protected override async Task OnInitializedAsync()
    {
        // Mock data for now (replace with API call later)
        _allPlans = new List<GrowthPlanListDto>
        {
            new() { 
                Id = Guid.NewGuid(), 
                PersonName = "Maria Santos", 
                Title = "Housing Stability", 
                Season = Season.Growing, 
                Status = GrowthPlanStatus.Active, 
                ProgressPercentage = 65 
            }
        };
        await Task.CompletedTask;
    }

    private IEnumerable<GrowthPlanListDto> FilteredPlans
    {
        get
        {
            if (string.IsNullOrWhiteSpace(SearchQuery)) return _allPlans;
            return _allPlans.Where(p => 
                (p.PersonName?.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ?? false) || 
                (p.Title?.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ?? false));
        }
    }

    private void ViewPlan(Guid id) => Navigation.NavigateTo($"/growth-plans/{id}");
    private void OpenNewPlan() => Navigation.NavigateTo("/growth-plans/new");
}