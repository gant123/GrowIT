@page "/growth-plans"
@using GrowIT.Client.Models
@using GrowIT.Shared.DTOs
@using GrowIT.Shared.Enums
@inject NavigationManager Navigation

<PageTitle>Growth Plans - grow.IT</PageTitle>

<div class="page-growth-plans">
    <div class="page-header">
        <div class="page-header-content">
            <h1 class="page-title">Growth Plans</h1>
            <p class="page-subtitle">Track progress and goals for people in your community.</p>
        </div>
        <div class="page-header-actions">
            <button class="btn btn-primary" @onclick="OpenNewPlan">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                New Growth Plan
            </button>
        </div>
    </div>

    <div class="status-tabs">
        <button class="status-tab @(_statusFilter == "" ? "active" : "")" @onclick='() => SetStatusFilter("")'>
            All Plans
            <span class="tab-count">@_allPlans.Count</span>
        </button>
        <button class="status-tab @(_statusFilter == "active" ? "active" : "")" @onclick='() => SetStatusFilter("active")'>
            Active
            <span class="tab-count">@_allPlans.Count(p => p.Status == GrowthPlanStatus.Active)</span>
        </button>
        <button class="status-tab @(_statusFilter == "onhold" ? "active" : "")" @onclick='() => SetStatusFilter("onhold")'>
            On Hold
            <span class="tab-count">@_allPlans.Count(p => p.Status == GrowthPlanStatus.OnHold)</span>
        </button>
        <button class="status-tab @(_statusFilter == "completed" ? "active" : "")" @onclick='() => SetStatusFilter("completed")'>
            Completed
            <span class="tab-count">@_allPlans.Count(p => p.Status == GrowthPlanStatus.Completed || p.Status == GrowthPlanStatus.Graduated)</span>
        </button>
    </div>

    <div class="toolbar">
        <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="search-icon">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" placeholder="Search plans or people..." @bind="_searchQuery" @bind:event="oninput" @bind:after="ApplyFilters" />
        </div>
        
        <div class="toolbar-filters">
            <select class="filter-select" @bind="_seasonFilter" @bind:after="ApplyFilters">
                <option value="">All Seasons</option>
                <option value="Crisis">Crisis</option>
                <option value="Planting">Planting</option>
                <option value="Growing">Growing</option>
                <option value="Harvest">Harvest</option>
            </select>
            
            <select class="filter-select" @bind="_assigneeFilter" @bind:after="ApplyFilters">
                <option value="">All Assignees</option>
                @foreach (var assignee in _assignees)
                {
                    <option value="@assignee">@assignee</option>
                }
            </select>
        </div>
    </div>

    <div class="plans-grid">
        @foreach (var plan in _filteredPlans)
        {
            <div class="plan-card" @onclick="() => ViewPlan(plan.Id)">
                <div class="plan-card-header">
                    <div class="plan-person">
                        <div class="avatar avatar-sm">
                            <span>@GetInitials(plan.PersonName)</span>
                        </div>
                        <div class="plan-person-info">
                            <span class="plan-person-name">@plan.PersonName</span>
                            <span class="plan-title">@plan.Title</span>
                        </div>
                    </div>
                    <span class="phase-badge phase-@plan.Season.ToString().ToLower()">
                        @plan.Season
                    </span>
                </div>

                <div class="plan-progress">
                    <div class="progress-header">
                        <span class="progress-label">Progress</span>
                        <span class="progress-value">@plan.CompletedGoals / @plan.TotalGoals goals</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: @plan.ProgressPercentage%"></div>
                    </div>
                    <div class="progress-percentage">@plan.ProgressPercentage.ToString("F0")% complete</div>
                </div>

                <div class="plan-details">
                    <div class="plan-detail">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="detail-icon">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        <span>Started @plan.StartDate.ToString("MMM d, yyyy")</span>
                    </div>
                    @if (plan.TargetEndDate.HasValue)
                    {
                        <div class="plan-detail">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="detail-icon">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            <span>Target: @plan.TargetEndDate.Value.ToString("MMM d, yyyy")</span>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(plan.AssignedToUserName))
                    {
                        <div class="plan-detail">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="detail-icon">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            <span>@plan.AssignedToUserName</span>
                        </div>
                    }
                </div>

                <div class="plan-card-footer">
                    <span class="plan-status status-@plan.Status.ToString().ToLower()">
                        @plan.Status
                    </span>
                    <div class="plan-actions" @onclick:stopPropagation="true">
                        <button class="btn-icon-only" title="View plan" @onclick="() => ViewPlan(plan.Id)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                        <button class="btn-icon-only" title="Edit plan" @onclick="() => EditPlan(plan.Id)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>

    @if (!_filteredPlans.Any())
    {
        <div class="empty-state-large">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="empty-icon">
                <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                <circle cx="12" cy="12" r="4"/>
            </svg>
            <h3>No growth plans found</h3>
            <p>Create a new growth plan to start tracking someone's journey.</p>
            <button class="btn btn-primary" @onclick="OpenNewPlan">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                New Growth Plan
            </button>
        </div>
    }
</div>

@code {
    private List<GrowthPlanListDto> _allPlans = new();
    private List<GrowthPlanListDto> _filteredPlans = new();
    private List<string> _assignees = new() { "John Doe", "Jane Smith", "Mike Johnson" };
    
    private string _searchQuery = "";
    private string _statusFilter = "";
    private string _seasonFilter = "";
    private string _assigneeFilter = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadPlans();
        ApplyFilters();
    }

    private async Task LoadPlans()
    {
        // Mock data
        _allPlans = new List<GrowthPlanListDto>
        {
            new() { Id = Guid.NewGuid(), PersonId = Guid.NewGuid(), PersonName = "Maria Santos", Title = "Housing Stability Plan", Season = Season.Growing, Status = GrowthPlanStatus.Active, StartDate = DateTime.Now.AddMonths(-3), TargetEndDate = DateTime.Now.AddMonths(3), CompletedGoals = 4, TotalGoals = 6, ProgressPercentage = 67, AssignedToUserName = "John Doe" },
            new() { Id = Guid.NewGuid(), PersonId = Guid.NewGuid(), PersonName = "James Wilson", Title = "Employment Development", Season = Season.Planting, Status = GrowthPlanStatus.Active, StartDate = DateTime.Now.AddMonths(-1), TargetEndDate = DateTime.Now.AddMonths(5), CompletedGoals = 1, TotalGoals = 5, ProgressPercentage = 20, AssignedToUserName = "Jane Smith" },
            new() { Id = Guid.NewGuid(), PersonId = Guid.NewGuid(), PersonName = "Sarah Johnson", Title = "Financial Independence", Season = Season.Harvest, Status = GrowthPlanStatus.Completed, StartDate = DateTime.Now.AddYears(-1), TargetEndDate = DateTime.Now.AddMonths(-1), CompletedGoals = 8, TotalGoals = 8, ProgressPercentage = 100, AssignedToUserName = "John Doe" },
            // FIXED: .AddWeeks(-2) -> .AddDays(-14)
            new() { Id = Guid.NewGuid(), PersonId = Guid.NewGuid(), PersonName = "Michael Chen", Title = "Crisis Stabilization", Season = Season.Crisis, Status = GrowthPlanStatus.Active, StartDate = DateTime.Now.AddDays(-14), CompletedGoals = 0, TotalGoals = 4, ProgressPercentage = 0, AssignedToUserName = "Mike Johnson" },
            new() { Id = Guid.NewGuid(), PersonId = Guid.NewGuid(), PersonName = "Robert Thompson", Title = "Emergency Support", Season = Season.Crisis, Status = GrowthPlanStatus.Active, StartDate = DateTime.Now.AddDays(-5), CompletedGoals = 1, TotalGoals = 3, ProgressPercentage = 33, AssignedToUserName = "Jane Smith" },
            new() { Id = Guid.NewGuid(), PersonId = Guid.NewGuid(), PersonName = "Linda Martinez", Title = "Senior Support Plan", Season = Season.Planting, Status = GrowthPlanStatus.OnHold, StartDate = DateTime.Now.AddMonths(-2), TargetEndDate = DateTime.Now.AddMonths(4), CompletedGoals = 2, TotalGoals = 5, ProgressPercentage = 40, AssignedToUserName = "John Doe" },
            new() { Id = Guid.NewGuid(), PersonId = Guid.NewGuid(), PersonName = "David Kim", Title = "Career Advancement", Season = Season.Growing, Status = GrowthPlanStatus.Active, StartDate = DateTime.Now.AddMonths(-4), TargetEndDate = DateTime.Now.AddMonths(2), CompletedGoals = 5, TotalGoals = 7, ProgressPercentage = 71, AssignedToUserName = "Mike Johnson" },
            new() { Id = Guid.NewGuid(), PersonId = Guid.NewGuid(), PersonName = "Angela Davis", Title = "Community Reintegration", Season = Season.Harvest, Status = GrowthPlanStatus.Graduated, StartDate = DateTime.Now.AddYears(-2), CompletedGoals = 10, TotalGoals = 10, ProgressPercentage = 100, AssignedToUserName = "Jane Smith" }
        };
        await Task.CompletedTask;
    }

    private void ApplyFilters()
    {
        var filtered = _allPlans.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(_searchQuery))
        {
            var query = _searchQuery.ToLower();
            filtered = filtered.Where(p => 
                p.PersonName.ToLower().Contains(query) ||
                p.Title.ToLower().Contains(query));
        }

        if (!string.IsNullOrEmpty(_statusFilter))
        {
            filtered = _statusFilter switch
            {
                "active" => filtered.Where(p => p.Status == GrowthPlanStatus.Active),
                "onhold" => filtered.Where(p => p.Status == GrowthPlanStatus.OnHold),
                "completed" => filtered.Where(p => p.Status == GrowthPlanStatus.Completed || p.Status == GrowthPlanStatus.Graduated),
                _ => filtered
            };
        }

        if (!string.IsNullOrEmpty(_seasonFilter) && Enum.TryParse<Season>(_seasonFilter, true, out var season))
        {
            filtered = filtered.Where(p => p.Season == season);
        }

        if (!string.IsNullOrEmpty(_assigneeFilter))
        {
            filtered = filtered.Where(p => p.AssignedToUserName == _assigneeFilter);
        }

        _filteredPlans = filtered.OrderByDescending(p => p.StartDate).ToList();
    }

    private void SetStatusFilter(string status)
    {
        _statusFilter = status;
        ApplyFilters();
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpperInvariant();
        return name.Length >= 2 ? name.Substring(0, 2).ToUpperInvariant() : name.ToUpperInvariant();
    }

    private void ViewPlan(Guid id) => Navigation.NavigateTo($"/growth-plans/{id}");
    private void EditPlan(Guid id) => Navigation.NavigateTo($"/growth-plans/{id}/edit");
    private void OpenNewPlan() { /* Open modal logic */ }
}