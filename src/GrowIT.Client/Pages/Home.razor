@page "/"
@attribute [Authorize]
@using GrowIT.Shared.DTOs
@using GrowIT.Client.Services
@using Syncfusion.Blazor.Charts 
@inject IDashboardService DashboardService
@inject NavigationManager Nav

<PageTitle>grow.IT - Impact Dashboard</PageTitle>

@if (stats == null)
{
    <div class="loading-state">
        <div class="spinner-growit"></div>
        <p class="loading-state-text">Loading impact data...</p>
    </div>
}
else
{
    <div class="dashboard fade-in">
        <PageHeader Title="Return on Impact" Subtitle="Translating service into sustainability.">
            <Actions>
                <button class="btn-growit btn-secondary-growit" @onclick="Refresh">
                    <span class="oi oi-reload me-1"></span> Refresh Data
                </button>
            </Actions>
        </PageHeader>

        <div class="grid-4 mb-4">
            <KpiCard Label="Direct Impact (YTD)" 
                     Value="@stats.TotalInvestedYtd.ToString("C0")" 
                     Icon="oi-heart" 
                     Color="success" 
                     TrendText="Capital Deployed" 
                     TrendIcon="oi-arrow-top" 
                     TrendDirection="up" />
            
            <KpiCard Label="Families Served" 
                     Value="@stats.HouseholdsServedYtd.ToString()" 
                     Icon="oi-people" 
                     Color="info" 
                     TrendText="Unique Households" />

            <KpiCard Label="Active Case Files" 
                     Value="@stats.ActiveCases.ToString()" 
                     Icon="oi-folder" 
                     Color="warning" 
                     TrendText="Managed Profiles" />
            
            <KpiCard Label="Funds Available" 
                     Value="@stats.FundsAvailable.ToString("C0")" 
                     Icon="oi-briefcase" 
                     Color="primary" 
                     TrendText="Capacity to Serve" />
        </div>

        <div class="card-growit mb-4">
            <div class="card-header">
                <h3 class="section-title">"The Harvest" - Growth Trends</h3>
                <div class="chart-legend">
                    <div class="legend-item impact">
                        <span class="legend-dot"></span>
                        <span>Monthly Impact Value</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                @if (stats?.MonthlyTrends != null && stats.MonthlyTrends.Any())
                {
                    <SfChart Height="350px" Width="100%" Background="transparent">
                        <ChartArea><ChartAreaBorder Width="0"></ChartAreaBorder></ChartArea>
                        <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.Category" 
                                           LabelPlacement="LabelPlacement.OnTicks">
                            <ChartAxisLabelStyle Color="transparent"></ChartAxisLabelStyle>
                            <ChartAxisMajorGridLines Width="0"></ChartAxisMajorGridLines>
                        </ChartPrimaryXAxis>
                        
                        <ChartPrimaryYAxis LabelFormat="${value}">
                            <ChartAxisLineStyle Width="0"></ChartAxisLineStyle>
                            <ChartAxisMajorTickLines Width="0"></ChartAxisMajorTickLines>
                        </ChartPrimaryYAxis>
                        
                        <ChartTooltipSettings Enable="true" Shared="true" Fill="#0f172a"></ChartTooltipSettings>
                        
                        <ChartSeriesCollection>
                            <ChartSeries DataSource="@stats.MonthlyTrends" 
                                         XName="Month" 
                                         YName="Amount" 
                                         Type="ChartSeriesType.SplineArea" 
                                         Width="3"
                                         Fill="var(--growit-green-glow)"
                                         Opacity="0.3">
                                <ChartSeriesBorder Width="3" Color="var(--growit-green)"></ChartSeriesBorder>
                                <ChartMarker Visible="true" Width="8" Height="8" Shape="ChartShape.Circle" Fill="white">
                                    <ChartMarkerBorder Width="2" Color="var(--growit-green)"></ChartMarkerBorder>
                                </ChartMarker>
                            </ChartSeries>
                        </ChartSeriesCollection>
                    </SfChart>
                }
                else
                {
                    <div class="d-flex justify-content-center align-items-center" style="height: 350px;">
                        <p class="text-muted">No trend data available for this period.</p>
                    </div>
                }
                </div>
            </div>
        </div>

        <div class="grid-2">
            <div class="card-growit">
                <div class="card-header">
                    <h3 class="section-title">Critical Action Items</h3>
                    <span class="badge-growit badge-warning">@stats.PendingFollowUps.Count Priority</span>
                </div>
                <div class="card-body p-0">
                    <div class="tasks-list">
                        @if (stats.PendingFollowUps.Any())
                        {
                            @foreach (var task in stats.PendingFollowUps)
                            {
                                <div class="task-item cursor-pointer" @onclick="() => NavigateToClient(task.ClientId)">
                                    <div class="task-content">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="task-action fw-600">@task.ClientName</span>
                                            <span class="badge-growit badge-neutral" style="color: var(--growit-text-secondary) !important;">Due @task.DueDate.ToString("MMM dd")</span>
                                        </div>
                                        <div class="task-client text-muted" style="color: var(--growit-text-muted) !important;">@task.Note</div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-state">
                                <span class="oi oi-circle-check empty-state-icon text-success"></span>
                                <div class="empty-state-title">Compliant</div>
                                <div class="empty-state-description">No pending follow-ups required at this time.</div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="card-growit">
                <div class="card-header">
                    <h3 class="section-title">"The Soil" - Recent Activity</h3>
                </div>
                <div class="card-body p-0">
                    <div class="activity-list">
                        @if (stats.RecentActivity.Any())
                        {
                            @foreach (var item in stats.RecentActivity)
                            {
                                <div class="activity-item">
                                    <div class="activity-icon @(GetActivityClass(item.Icon))">
                                        <span class="oi @item.Icon"></span>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-text">@item.Description</div>
                                        <div class="activity-meta" style="color: var(--growit-text-muted) !important;">@GetTimeAgo(item.Date)</div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-state">
                                <p class="text-muted">No operational activity recorded.</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private DashboardStatsDto? stats;

    protected override async Task OnInitializedAsync()
    {
        await Refresh();
    }

    private async Task Refresh()
    {
        try 
        {
            stats = await DashboardService.GetStatsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
    }

    private void NavigateToClient(Guid clientId)
    {
        Nav.NavigateTo($"clients/{clientId}");
    }

    private string GetTimeAgo(DateTime date)
    {
        var span = DateTime.UtcNow - date;
        if (span.TotalMinutes < 1) return "Just now";
        if (span.TotalHours < 1) return $"{(int)span.TotalMinutes}m ago";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours}h ago";
        return $"{(int)span.TotalDays}d ago";
    }

    private string GetActivityClass(string icon)
    {
        if (icon.Contains("dollar")) return "investment";
        if (icon.Contains("people") || icon.Contains("person") || icon.Contains("flag")) return "client";
        return "fund";
    }
}