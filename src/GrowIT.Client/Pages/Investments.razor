@page "/investments"
@page "/investments/new"

@using GrowIT.Client.Services
@using GrowIT.Shared.DTOs
@using GrowIT.Shared.Enums
@using InvestmentStatusEnum = GrowIT.Shared.Enums.InvestmentStatus;

@@inject IInvestmentService InvestmentService
@inject NavigationManager Navigation

<PageTitle>Investments - grow.IT</PageTitle>

<div class="page-investments">
    <div class="filters-bar d-flex gap-3 mb-3">
        <div class="filter-group search-group flex-grow-1">
            <input type="text" class="form-control" placeholder="Search..." @bind="_searchQuery" @bind:event="oninput" @onkeyup="HandleSearch" />
        </div>
        <div class="filter-group">
            <select class="form-select" @bind="_statusFilter" @bind:after="LoadData">
                <option value="">All Statuses</option>
              @foreach (var status in Enum.GetValues<InvestmentStatusEnum>())
{
    <option value="@status">@status</option>
}

            </select>
        </div>
    </div>

    <div class="data-table-container mt-3">
        @if (_isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Loading investments...</p>
            </div>
        }
        else
        {
            <table class="table table-hover align-middle shadow-sm bg-white rounded">
                <thead class="bg-light">
                    <tr>
                        <th class="sortable" style="cursor: pointer;" @onclick='async () => await SetSort("Date")'>
                            Date @RenderSortIcon("Date")
                        </th>
                        <th class="sortable" style="cursor: pointer;" @onclick='async () => await SetSort("PersonName")'>
                            Person @RenderSortIcon("PersonName")
                        </th>
                        <th>Purpose</th>
                        <th>Category</th>
                        <th class="sortable text-end" style="cursor: pointer;" @onclick='async () => await SetSort("Amount")'>
                            Amount @RenderSortIcon("Amount")
                        </th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var inv in _investments)
                    {
                        <tr>
                            <td>@inv.Date.ToString("MMM d, yyyy")</td>
                            <td class="fw-bold text-primary">@inv.PersonName</td>
                            <td>@inv.Purpose</td>
                            <td><span class="badge bg-secondary">@inv.Category</span></td>
                            <td class="text-end fw-bold">@inv.Amount.ToString("C0")</td>
                            <td>
                                <span class="badge @GetStatusBadge(inv.Status)">@inv.Status</span>
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-light" @onclick="() => EditInvestment(inv.Id)">Edit</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            
            <div class="d-flex justify-content-between align-items-center mt-3 px-2">
                <span class="text-muted small">Page @_currentPage</span>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-2" disabled="@(_currentPage == 1)" @onclick="PreviousPage">Previous</button>
                    <button class="btn btn-sm btn-outline-secondary" disabled="@(!_hasMore)" @onclick="NextPage">Next</button>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private List<InvestmentListDto> _investments = new();
    private bool _isLoading = false;
    private string _searchQuery = "";
    private string _statusFilter = "";
    
    private string _sortBy = "Date";
    private bool _sortDescending = true;
    private int _currentPage = 1;
    private int _pageSize = 20; 
    private bool _hasMore = true;
    
    private InvestmentQueryParams _queryParams = new();

    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            _queryParams.PageNumber = _currentPage;
            _queryParams.PageSize = _pageSize;
            _queryParams.SearchTerm = _searchQuery;
            _queryParams.SortBy = _sortBy;
            _queryParams.SortDescending = _sortDescending;
            
            // Fixed: Now cleanly uses the Shared Enum
if (!string.IsNullOrEmpty(_statusFilter)
    && Enum.TryParse<InvestmentStatusEnum>(_statusFilter, out var status))
{
    _queryParams.Status = status;
}
else
{
    _queryParams.Status = null;
}

            var response = await InvestmentService.GetInvestmentsAsync(_queryParams);
            _investments = response.Items ?? new List<InvestmentListDto>();
            _hasMore = _investments.Count == _pageSize;
        }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
        finally { _isLoading = false; }
    }

    private async Task HandleSearch(KeyboardEventArgs e) { if (e.Key == "Enter") await LoadData(); }

    private async Task SetSort(string column)
    {
        if (_sortBy == column) _sortDescending = !_sortDescending;
        else { _sortBy = column; _sortDescending = true; }
        await LoadData();
    }

    private async Task PreviousPage() { if (_currentPage > 1) { _currentPage--; await LoadData(); } }
    private async Task NextPage() { _currentPage++; await LoadData(); }

    private RenderFragment RenderSortIcon(string column) => builder =>
    {
        if (_sortBy != column) return;
        builder.OpenElement(0, "span");
        builder.AddAttribute(1, "class", $"oi oi-caret-{(_sortDescending ? "bottom" : "top")} ms-1 small text-muted");
        builder.CloseElement();
    };

    private string GetStatusBadge(InvestmentStatus status) => status switch
    {
        InvestmentStatus.Approved => "bg-success",
        InvestmentStatus.Pending => "bg-warning text-dark",
        InvestmentStatus.Rejected => "bg-danger",
        _ => "bg-secondary"
    };

    private void EditInvestment(Guid id) => Navigation.NavigateTo($"/investments/{id}/edit");
}