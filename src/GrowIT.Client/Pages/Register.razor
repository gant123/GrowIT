@page "/register"
@layout PublicLayout
@inject NavigationManager Navigation

<PageTitle>Create Account - grow.IT</PageTitle>

<div class="auth-page">
    <div class="auth-container">
        <div class="auth-card register-card">
            <!-- Logo -->
            <div class="auth-logo">
                <a href="/welcome">
                    <svg class="brand-icon" viewBox="0 0 32 32" fill="none">
                        <circle cx="16" cy="16" r="14" fill="url(#regGradient)"/>
                        <path d="M16 8c0 4-2 6-2 10s2 6 2 6M12 14c2-2 6-2 8 0M10 18c3-2 9-2 12 0" 
                              stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                        <defs>
                            <linearGradient id="regGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#22c55e"/>
                                <stop offset="100%" stop-color="#16a34a"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <span class="brand-text">grow<span class="brand-highlight">.IT</span></span>
                </a>
            </div>

            <!-- Header -->
            <div class="auth-header">
                <h1>Create your account</h1>
                <p>Start your 14-day free trial. No credit card required.</p>
            </div>

            <!-- Progress Steps -->
            <div class="register-steps">
                <div class="step @(_currentStep >= 1 ? "active" : "") @(_currentStep > 1 ? "completed" : "")">
                    <div class="step-number">
                        @if (_currentStep > 1)
                        {
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        }
                        else
                        {
                            <span>1</span>
                        }
                    </div>
                    <span class="step-label">Account</span>
                </div>
                <div class="step-line @(_currentStep > 1 ? "active" : "")"></div>
                <div class="step @(_currentStep >= 2 ? "active" : "") @(_currentStep > 2 ? "completed" : "")">
                    <div class="step-number">
                        @if (_currentStep > 2)
                        {
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        }
                        else
                        {
                            <span>2</span>
                        }
                    </div>
                    <span class="step-label">Organization</span>
                </div>
                <div class="step-line @(_currentStep > 2 ? "active" : "")"></div>
                <div class="step @(_currentStep >= 3 ? "active" : "")">
                    <div class="step-number"><span>3</span></div>
                    <span class="step-label">Setup</span>
                </div>
            </div>

            <!-- Error Alert -->
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="auth-alert error">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                    <span>@_errorMessage</span>
                </div>
            }

            <!-- Step 1: Account Info -->
            @if (_currentStep == 1)
            {
                <form class="auth-form" @onsubmit="GoToStep2" @onsubmit:preventDefault>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">First name</label>
                            <input type="text" 
                                   id="firstName" 
                                   @bind="_firstName" 
                                   placeholder="John"
                                   autocomplete="given-name"
                                   required />
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last name</label>
                            <input type="text" 
                                   id="lastName" 
                                   @bind="_lastName" 
                                   placeholder="Smith"
                                   autocomplete="family-name"
                                   required />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email">Work email</label>
                        <input type="email" 
                               id="email" 
                               @bind="_email" 
                               placeholder="you@nonprofit.org"
                               autocomplete="email"
                               required />
                    </div>

                    <div class="form-group">
                        <label for="password">Password</label>
                        <div class="input-wrapper">
                            <input type="@(_showPassword ? "text" : "password")" 
                                   id="password" 
                                   @bind="_password" 
                                   @oninput="CheckPasswordStrength"
                                   placeholder="Create a strong password"
                                   autocomplete="new-password"
                                   minlength="8"
                                   required />
                            <button type="button" class="password-toggle" @onclick="() => _showPassword = !_showPassword">
                                @if (_showPassword)
                                {
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                        <line x1="1" y1="1" x2="23" y2="23"/>
                                    </svg>
                                }
                                else
                                {
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                }
                            </button>
                        </div>
                        <div class="password-strength">
                            <div class="strength-bar">
                                <div class="strength-fill @_passwordStrengthClass" style="width: @_passwordStrength%"></div>
                            </div>
                            <span class="strength-text">@_passwordStrengthText</span>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block btn-lg">
                        Continue
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"/>
                            <polyline points="12 5 19 12 12 19"/>
                        </svg>
                    </button>
                </form>

                <!-- Divider -->
                <div class="auth-divider">
                    <span>or sign up with</span>
                </div>

                <!-- Social Signup -->
                <div class="social-buttons">
                    <button type="button" class="btn btn-social" @onclick="SignupWithGoogle">
                        <svg viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Google
                    </button>
                    <button type="button" class="btn btn-social" @onclick="SignupWithMicrosoft">
                        <svg viewBox="0 0 24 24">
                            <path fill="#F25022" d="M1 1h10v10H1z"/>
                            <path fill="#00A4EF" d="M1 13h10v10H1z"/>
                            <path fill="#7FBA00" d="M13 1h10v10H13z"/>
                            <path fill="#FFB900" d="M13 13h10v10H13z"/>
                        </svg>
                        Microsoft
                    </button>
                </div>
            }

            <!-- Step 2: Organization Info -->
            @if (_currentStep == 2)
            {
                <form class="auth-form" @onsubmit="GoToStep3" @onsubmit:preventDefault>
                    <div class="form-group">
                        <label for="orgName">Organization name</label>
                        <input type="text" 
                               id="orgName" 
                               @bind="_organizationName" 
                               placeholder="Community Hope Network"
                               required />
                    </div>

                    <div class="form-group">
                        <label for="orgType">Organization type</label>
                        <select id="orgType" @bind="_organizationType" required>
                            <option value="">Select type...</option>
                            <option value="501c3">501(c)(3) Nonprofit</option>
                            <option value="church">Church/Religious Organization</option>
                            <option value="government">Government Agency</option>
                            <option value="school">Educational Institution</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="orgSize">How many people do you serve annually?</label>
                        <select id="orgSize" @bind="_organizationSize" required>
                            <option value="">Select range...</option>
                            <option value="1-50">1-50</option>
                            <option value="51-200">51-200</option>
                            <option value="201-500">201-500</option>
                            <option value="501-1000">501-1,000</option>
                            <option value="1000+">1,000+</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="role">Your role</label>
                        <select id="role" @bind="_role" required>
                            <option value="">Select role...</option>
                            <option value="executive">Executive Director / CEO</option>
                            <option value="program">Program Director / Manager</option>
                            <option value="case">Case Manager</option>
                            <option value="admin">Administrator</option>
                            <option value="volunteer">Volunteer Coordinator</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-ghost" @onclick="() => _currentStep = 1">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="19" y1="12" x2="5" y2="12"/>
                                <polyline points="12 19 5 12 12 5"/>
                            </svg>
                            Back
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg">
                            Continue
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"/>
                                <polyline points="12 5 19 12 12 19"/>
                            </svg>
                        </button>
                    </div>
                </form>
            }

            <!-- Step 3: Final Setup -->
            @if (_currentStep == 3)
            {
                <form class="auth-form" @onsubmit="CompleteRegistration" @onsubmit:preventDefault>
                    <div class="setup-options">
                        <h3>What would you like to track?</h3>
                        <p class="setup-hint">Select all that apply. You can change these later.</p>
                        
                        <div class="checkbox-cards">
                            <label class="checkbox-card @(_trackPeople ? "selected" : "")">
                                <input type="checkbox" @bind="_trackPeople" />
                                <div class="card-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                    </svg>
                                </div>
                                <span class="card-label">People / Clients</span>
                                <span class="card-desc">Track individuals and families you serve</span>
                            </label>
                            
                            <label class="checkbox-card @(_trackInvestments ? "selected" : "")">
                                <input type="checkbox" @bind="_trackInvestments" />
                                <div class="card-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="1" x2="12" y2="23"/>
                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                    </svg>
                                </div>
                                <span class="card-label">Financial Assistance</span>
                                <span class="card-desc">Track investments, grants, and disbursements</span>
                            </label>
                            
                            <label class="checkbox-card @(_trackOutcomes ? "selected" : "")">
                                <input type="checkbox" @bind="_trackOutcomes" />
                                <div class="card-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                        <polyline points="22 4 12 14.01 9 11.01"/>
                                    </svg>
                                </div>
                                <span class="card-label">Outcomes / Impact</span>
                                <span class="card-desc">Document and measure your impact</span>
                            </label>
                            
                            <label class="checkbox-card @(_trackPrograms ? "selected" : "")">
                                <input type="checkbox" @bind="_trackPrograms" />
                                <div class="card-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="3" y1="9" x2="21" y2="9"/>
                                        <line x1="9" y1="21" x2="9" y2="9"/>
                                    </svg>
                                </div>
                                <span class="card-label">Programs / Services</span>
                                <span class="card-desc">Organize by program or service type</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" @bind="_agreeToTerms" required />
                            <span class="checkbox-custom"></span>
                            <span>I agree to the <a href="/terms" target="_blank">Terms of Service</a> and <a href="/privacy" target="_blank">Privacy Policy</a></span>
                        </label>
                    </div>

                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" @bind="_subscribeToUpdates" />
                            <span class="checkbox-custom"></span>
                            <span>Send me tips and product updates (optional)</span>
                        </label>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-ghost" @onclick="() => _currentStep = 2">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="19" y1="12" x2="5" y2="12"/>
                                <polyline points="12 19 5 12 12 5"/>
                            </svg>
                            Back
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg" disabled="@_isLoading">
                            @if (_isLoading)
                            {
                                <span class="btn-spinner"></span>
                                <span>Creating account...</span>
                            }
                            else
                            {
                                <span>Create Account</span>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            }
                        </button>
                    </div>
                </form>
            }

            <!-- Footer -->
            <div class="auth-footer">
                <p>Already have an account? <a href="/login">Sign in</a></p>
            </div>
        </div>

        <!-- Side Content -->
        <div class="auth-side register-side">
            <div class="auth-side-content">
                <h2>Why nonprofits choose grow.IT</h2>
                <ul class="benefits-list">
                    <li>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        <span><strong>Save 10+ hours/month</strong> on reporting</span>
                    </li>
                    <li>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        <span><strong>Increase funding</strong> with better impact data</span>
                    </li>
                    <li>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        <span><strong>Track every dollar</strong> from intake to outcome</span>
                    </li>
                    <li>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        <span><strong>Designed for nonprofits</strong> not adapted from CRM</span>
                    </li>
                </ul>
                
                <div class="trial-badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="8" r="7"/>
                        <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
                    </svg>
                    <span>14-day free trial<br/>No credit card required</span>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private int _currentStep = 1;
    
    // Step 1
    private string _firstName = "";
    private string _lastName = "";
    private string _email = "";
    private string _password = "";
    private bool _showPassword = false;
    private int _passwordStrength = 0;
    private string _passwordStrengthClass = "";
    private string _passwordStrengthText = "";
    
    // Step 2
    private string _organizationName = "";
    private string _organizationType = "";
    private string _organizationSize = "";
    private string _role = "";
    
    // Step 3
    private bool _trackPeople = true;
    private bool _trackInvestments = true;
    private bool _trackOutcomes = true;
    private bool _trackPrograms = false;
    private bool _agreeToTerms = false;
    private bool _subscribeToUpdates = false;
    
    private bool _isLoading = false;
    private string? _errorMessage;

    private void CheckPasswordStrength(ChangeEventArgs e)
    {
        var password = e.Value?.ToString() ?? "";
        _password = password;
        
        var score = 0;
        if (password.Length >= 8) score += 25;
        if (password.Length >= 12) score += 15;
        if (System.Text.RegularExpressions.Regex.IsMatch(password, @"[A-Z]")) score += 20;
        if (System.Text.RegularExpressions.Regex.IsMatch(password, @"[a-z]")) score += 10;
        if (System.Text.RegularExpressions.Regex.IsMatch(password, @"[0-9]")) score += 15;
        if (System.Text.RegularExpressions.Regex.IsMatch(password, @"[^a-zA-Z0-9]")) score += 15;
        
        _passwordStrength = Math.Min(score, 100);
        
        (_passwordStrengthClass, _passwordStrengthText) = _passwordStrength switch
        {
            < 30 => ("weak", "Weak"),
            < 60 => ("fair", "Fair"),
            < 80 => ("good", "Good"),
            _ => ("strong", "Strong")
        };
    }

    private void GoToStep2()
    {
        if (_password.Length < 8)
        {
            _errorMessage = "Password must be at least 8 characters.";
            return;
        }
        _errorMessage = null;
        _currentStep = 2;
    }

    private void GoToStep3()
    {
        _errorMessage = null;
        _currentStep = 3;
    }

    private async Task CompleteRegistration()
    {
        if (!_agreeToTerms)
        {
            _errorMessage = "Please agree to the Terms of Service and Privacy Policy.";
            return;
        }

        _errorMessage = null;
        _isLoading = true;

        try
        {
            // Simulate API call
            await Task.Delay(2000);
            
            // In production, this would create the account
            Navigation.NavigateTo("/");
        }
        catch (Exception)
        {
            _errorMessage = "An error occurred. Please try again later.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void SignupWithGoogle()
    {
        // OAuth with Google
    }

    private void SignupWithMicrosoft()
    {
        // OAuth with Microsoft
    }
}
