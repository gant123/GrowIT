@page "/reset-password"
@layout PublicLayout
@using GrowIT.Shared.DTOs
@using GrowIT.Client.Services
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Reset Password - grow.IT</PageTitle>

<div class="auth-page">
    <div class="auth-container auth-container-centered">
        <div class="auth-card">
            <!-- Logo -->
            <div class="auth-logo">
                <a href="/welcome">
                    <img src="images/logo-@(_currentTheme).png" alt="GrowIT" class="brand-logo" />
                </a>
            </div>

            @if (!_passwordReset)
            {
                <div class="auth-header">
                    <h1>Create new password</h1>
                    <p>Enter your new password below.</p>
                </div>

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="auth-alert error">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        <span>@_errorMessage</span>
                    </div>
                }

                <form class="auth-form" @onsubmit="HandleReset" @onsubmit:preventDefault>
                    <div class="form-group">
                        <label for="password">New Password</label>
                        <div class="input-wrapper">
                            <input type="@(_showPassword ? "text" : "password")" 
                                   id="password" 
                                   @bind="_newPassword" 
                                   placeholder="Min 6 characters"
                                   required />
                            <button type="button" class="password-toggle" @onclick="TogglePassword">
                                @if (_showPassword)
                                {
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                                }
                                else
                                {
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                }
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="confirm-password">Confirm New Password</label>
                        <div class="input-wrapper">
                            <input type="@(_showPassword ? "text" : "password")" 
                                   id="confirm-password" 
                                   @bind="_confirmPassword" 
                                   placeholder="Repeat new password"
                                   required />
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block btn-lg" disabled="@_isLoading">
                        @if (_isLoading)
                        {
                            <span class="btn-spinner"></span>
                            <span>Resetting...</span>
                        }
                        else
                        {
                            <span>Reset Password</span>
                        }
                    </button>
                </form>
            }
            else
            {
                <div class="auth-success">
                    <div class="success-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                    </div>
                    <h2>Password reset!</h2>
                    <p>Your password has been successfully updated.</p>
                    <a href="/login" class="btn btn-primary btn-block mt-4">Sign In</a>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string _currentTheme = "light";
    private string _newPassword = "";
    private string _confirmPassword = "";
    private string _token = "";
    private string _email = "";
    private bool _isLoading = false;
    private bool _passwordReset = false;
    private bool _showPassword = false;
    private string? _errorMessage;

    protected override void OnInitialized()
    {
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        
        _token = query["token"] ?? "";
        _email = query["email"] ?? "";

        if (string.IsNullOrEmpty(_token) || string.IsNullOrEmpty(_email))
        {
            _errorMessage = "Invalid password reset link.";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _currentTheme = await JS.InvokeAsync<string>("blazorInterop.getTheme");
            StateHasChanged();
        }
    }

    private void TogglePassword() => _showPassword = !_showPassword;

    private async Task HandleReset()
    {
        if (_newPassword != _confirmPassword)
        {
            _errorMessage = "Passwords do not match.";
            return;
        }

        if (_newPassword.Length < 6)
        {
            _errorMessage = "Password must be at least 6 characters long.";
            return;
        }

        _errorMessage = null;
        _isLoading = true;

        try
        {
            var request = new ResetPasswordRequest 
            { 
                Email = _email, 
                Token = _token, 
                NewPassword = _newPassword 
            };

            var success = await AuthService.ResetPassword(request);
            
            if (success)
            {
                _passwordReset = true;
            }
            else
            {
                _errorMessage = "Unable to reset password. The link may have expired.";
            }
        }
        catch (Exception)
        {
            _errorMessage = "An error occurred. Please try again later.";
        }
        finally
        {
            _isLoading = false;
        }
    }
}
